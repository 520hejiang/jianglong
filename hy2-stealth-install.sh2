#!/bin/bash

export LANG=en_US.UTF-8

RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
PLAIN="\033[0m"

red() { echo -e "${RED}$1${PLAIN}"; }
green() { echo -e "${GREEN}$1${PLAIN}"; }
yellow() { echo -e "${YELLOW}$1${PLAIN}"; }

CONFIG_DIR="/etc/hysteria2"
CLIENT_DIR="/root/hysteria2-client"
LOG_FILE="/var/log/hysteria2.log"
NGINX_DIR="/var/www/fake-site"

[[ $EUID -ne 0 ]] && red "[!] è¯·ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œæœ¬è„šæœ¬ï¼" && exit 1

SYSTEM=""
CMD=("$(grep -i pretty_name /etc/os-release 2>/dev/null | cut -d \" -f2)" "$(hostnamectl 2>/dev/null | grep -i system | cut -d : -f2)" "$(lsb_release -sd 2>/dev/null)")
REGEX=("debian" "ubuntu" "centos")
RELEASE=("Debian" "Ubuntu" "CentOS")
PACKAGE_INSTALL=("apt -y install" "apt -y install" "yum -y install")
PACKAGE_UPDATE=("apt update -y" "apt update -y" "yum update -y")

for i in "${CMD[@]}"; do
  SYS="$i" && [[ -n $SYS ]] && break
done

for ((i = 0; i < ${#REGEX[@]}; i++)); do
  [[ $(echo "$SYS" | tr '[:upper:]' '[:lower:]') =~ ${REGEX[i]} ]] && SYSTEM="${RELEASE[i]}" && PKG_INDEX=$i && break
done

[[ -z $SYSTEM ]] && red "[!] æš‚ä¸æ”¯æŒè¯¥ç³»ç»Ÿï¼" && exit 1

install_deps() {
  yellow "[*] å®‰è£…ä¾èµ–ä¸­..."
  ${PACKAGE_UPDATE[PKG_INDEX]}
  ${PACKAGE_INSTALL[PKG_INDEX]} curl wget qrencode openssl iptables-persistent netfilter-persistent ufw fail2ban certbot nginx git unzip
  if ! systemctl is-active --quiet fail2ban; then
    systemctl enable --now fail2ban
  fi
  green "[*] ä¾èµ–å®‰è£…å®Œæˆ"
}

get_ip() {
  IP_SOURCES=("https://icanhazip.com" "https://ipv4.icanhazip.com" "https://api.ipify.org")
  for source in "${IP_SOURCES[@]}"; do
    IP=$(curl -s --connect-timeout 5 --max-time 10 "$source" 2>/dev/null | grep -E '^[0-9.]+$')
    [[ -n "$IP" ]] && break
  done
  [[ -z "$IP" ]] && red "[!] æ— æ³•è·å–å…¬ç½‘ IP" && exit 1
  yellow "[*] æ£€æµ‹åˆ°å…¬ç½‘IP: $IP"
}

generate_cert() {
  mkdir -p "$CONFIG_DIR"
  chmod 700 "$CONFIG_DIR"
  yellow "[*] è¯ä¹¦ç”Ÿæˆæ–¹å¼ï¼š"
  echo "1) ä½¿ç”¨çœŸå®åŸŸåç”³è¯· Let's Encrypt è¯ä¹¦ï¼ˆæ¨èï¼‰"
  echo "2) ç”Ÿæˆè‡ªç­¾åè¯ä¹¦"
  read -p "è¯·é€‰æ‹© [1-2]: " cert_choice
  
  if [[ "$cert_choice" == "1" ]]; then
    read -p "è¯·è¾“å…¥åŸŸå: " DOMAIN
    [[ -z "$DOMAIN" ]] && red "[!] åŸŸåä¸èƒ½ä¸ºç©º" && exit 1
    yellow "[!] è¯·ç¡®ä¿åŸŸåå·²è§£æåˆ°: $IP"
    read -p "åŸŸåæ˜¯å¦å·²æ­£ç¡®è§£æï¼Ÿ(y/n): " dns_confirm
    [[ "$dns_confirm" != "y" ]] && red "[!] è¯·å…ˆé…ç½®åŸŸåè§£æ" && exit 1
    
    systemctl stop nginx 2>/dev/null || true
    certbot certonly --standalone -d "$DOMAIN" --non-interactive --agree-tos --email admin@"$DOMAIN" --http-01-port 80
    
    if [[ $? -eq 0 ]]; then
      ln -sf /etc/letsencrypt/live/"$DOMAIN"/fullchain.pem "$CONFIG_DIR/cert.crt"
      ln -sf /etc/letsencrypt/live/"$DOMAIN"/privkey.pem "$CONFIG_DIR/private.key"
      USE_REAL_CERT=true
      SNI_DOMAIN="$DOMAIN"
      green "[*] è¯ä¹¦ç”³è¯·æˆåŠŸ"
      (crontab -l 2>/dev/null; echo "0 3 * * * certbot renew --quiet --deploy-hook 'systemctl reload nginx && systemctl restart hysteria2'") | crontab -
    else
      USE_REAL_CERT=false
    fi
  else
    USE_REAL_CERT=false
  fi
  
  if [[ "$USE_REAL_CERT" != "true" ]]; then
    openssl ecparam -genkey -name secp384r1 -out "$CONFIG_DIR/private.key"
    FAKE_DOMAINS=("cloudflare.com" "www.google.com" "api.github.com")
    FAKE_DOMAIN=${FAKE_DOMAINS[$RANDOM % ${#FAKE_DOMAINS[@]}]}
    SNI_DOMAIN="$FAKE_DOMAIN"
    openssl req -new -x509 -days 36500 -key "$CONFIG_DIR/private.key" -out "$CONFIG_DIR/cert.crt" -subj "/C=US/ST=CA/O=Tech/CN=$FAKE_DOMAIN"
  fi
  
  chmod 600 "$CONFIG_DIR/private.key"
  chmod 644 "$CONFIG_DIR/cert.crt"
}

set_port() {
  yellow "[*] ç«¯å£é€‰æ‹©ï¼š"
  echo "1) 443 (æ¨è)"
  echo "2) 8443"
  echo "3) éšæœºç«¯å£"
  echo "4) è‡ªå®šä¹‰"
  read -p "è¯·é€‰æ‹© [1-4]: " port_choice
  
  case "$port_choice" in
    1) PORT=443 ;;
    2) PORT=8443 ;;
    4) 
      read -p "è¯·è¾“å…¥ç«¯å£: " PORT
      [[ ! "$PORT" =~ ^[0-9]+$ ]] && red "[!] æ— æ•ˆç«¯å£" && exit 1
      ;;
    *) PORT=443 ;;
  esac
  
  if ss -tlnp | grep -q ":$PORT "; then
    PORT=$((RANDOM % 50000 + 10000))
  fi
  yellow "[*] ä½¿ç”¨ç«¯å£: $PORT"
}

install_hysteria() {
  yellow "[*] å®‰è£… Hysteria2..."
  INSTALL_SCRIPT=$(mktemp)
  curl -fsSL https://get.hy2.sh -o "$INSTALL_SCRIPT" || { red "[!] ä¸‹è½½å¤±è´¥"; exit 1; }
  bash "$INSTALL_SCRIPT"
  rm -f "$INSTALL_SCRIPT"
  command -v hysteria &> /dev/null || { red "[!] å®‰è£…å¤±è´¥"; exit 1; }
  green "[*] Hysteria2 å®‰è£…æˆåŠŸ"
}

generate_salamander_key() {
  SALAMANDER_KEY=$(openssl rand -hex 16)
  yellow "[*] Salamanderå¯†é’¥: $SALAMANDER_KEY"
}

deploy_fake_website() {
  yellow "[*] éƒ¨ç½²ä¼ªè£…ç½‘ç«™..."
  echo "1) å…‹éš†çœŸå®ç½‘ç«™"
  echo "2) ä½¿ç”¨æ¨¡æ¿"
  echo "3) ç®€å•é¡µé¢"
  read -p "é€‰æ‹© [1-3]: " site_choice
  
  mkdir -p "$NGINX_DIR"
  
  if [[ "$site_choice" == "1" ]]; then
    read -p "è¾“å…¥URL: " CLONE_URL
    [[ -n "$CLONE_URL" ]] && wget -q --mirror --convert-links -P "$NGINX_DIR" "$CLONE_URL" 2>/dev/null || site_choice=3
  elif [[ "$site_choice" == "2" ]]; then
    wget -q -O /tmp/tpl.zip "https://github.com/BlackrockDigital/startbootstrap-landing-page/archive/master.zip" 2>/dev/null && \
    unzip -q /tmp/tpl.zip -d /tmp/ && cp -r /tmp/startbootstrap-landing-page-master/* "$NGINX_DIR/" && \
    rm -rf /tmp/tpl.zip /tmp/startbootstrap-landing-page-master || site_choice=3
  fi
  
  if [[ "$site_choice" == "3" ]] || [[ ! -f "$NGINX_DIR/index.html" ]]; then
    cat > "$NGINX_DIR/index.html" <<'HTMLEOF'
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud Services</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;line-height:1.6;color:#333}
header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:2rem 0}
.container{max-width:1200px;margin:0 auto;padding:0 20px}
h1{font-size:2.5rem;margin-bottom:1rem}
.features{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:2rem;padding:4rem 0}
.feature{padding:2rem;background:#f8f9fa;border-radius:8px;text-align:center}
.feature h3{color:#667eea;margin-bottom:1rem}
footer{background:#2c3e50;color:#fff;text-align:center;padding:2rem 0;margin-top:4rem}
</style>
</head>
<body>
<header>
<div class="container">
<h1>Enterprise Cloud Solutions</h1>
<p>Secure, Scalable, Reliable Infrastructure</p>
</div>
</header>
<div class="container">
<div class="features">
<div class="feature">
<h3>ğŸ”’ Security</h3>
<p>Enterprise-grade security with end-to-end encryption.</p>
</div>
<div class="feature">
<h3>âš¡ Performance</h3>
<p>99.99% uptime with global CDN.</p>
</div>
<div class="feature">
<h3>ğŸ“ˆ Scalable</h3>
<p>Scale seamlessly as you grow.</p>
</div>
</div>
</div>
<footer>
<div class="container">
<p>&copy; 2025 Cloud Services. All rights reserved.</p>
</div>
</footer>
</body>
</html>
HTMLEOF
  fi
  chmod -R 755 "$NGINX_DIR"
  green "[*] ä¼ªè£…ç½‘ç«™éƒ¨ç½²å®Œæˆ"
}

configure_nginx() {
  yellow "[*] é…ç½® Nginx..."
  [[ -f /etc/nginx/nginx.conf ]] && cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak
  
  cat > /etc/nginx/sites-available/hysteria2 <<NGINXEOF
limit_req_zone \$binary_remote_addr zone=general:10m rate=10r/s;
limit_conn_zone \$binary_remote_addr zone=addr:10m;

server {
    listen 80;
    server_name ${SNI_DOMAIN} _;
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name ${SNI_DOMAIN} _;
    
    ssl_certificate ${CONFIG_DIR}/cert.crt;
    ssl_certificate_key ${CONFIG_DIR}/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    limit_req zone=general burst=20 nodelay;
    limit_conn addr 10;
    
    root ${NGINX_DIR};
    index index.html;
    
    location / {
        try_files \$uri \$uri/ =404;
    }
    
    location /api/ {
        return 200 '{"status":"ok"}';
        add_header Content-Type application/json;
    }
    
    location /robots.txt {
        return 200 "User-agent: *\nDisallow: /admin/\n";
    }
    
    server_tokens off;
}
NGINXEOF

  ln -sf /etc/nginx/sites-available/hysteria2 /etc/nginx/sites-enabled/
  rm -f /etc/nginx/sites-enabled/default
  
  if nginx -t 2>/dev/null; then
    systemctl restart nginx
    systemctl enable nginx
    green "[*] Nginx é…ç½®æˆåŠŸ"
  else
    red "[!] Nginx é…ç½®å¤±è´¥"
    nginx -t
  fi
}

write_config() {
  PASS=$(openssl rand -base64 18 | tr -d "=+/" | cut -c1-24)
  mkdir -p "$CLIENT_DIR"
  chmod 700 "$CLIENT_DIR"

  cat > "$CONFIG_DIR/config.yaml" <<SERVEREOF
listen: :$PORT

tls:
  cert: $CONFIG_DIR/cert.crt
  key: $CONFIG_DIR/private.key

auth:
  type: password
  password: $PASS

obfs:
  type: salamander
  salamander:
    password: $SALAMANDER_KEY

masquerade:
  type: proxy
  proxy:
    url: http://127.0.0.1:80
    rewriteHost: true

quic:
  initStreamReceiveWindow: 8388608
  maxStreamReceiveWindow: 8388608
  initConnReceiveWindow: 20971520
  maxConnReceiveWindow: 20971520
  maxIdleTimeout: 60s
  keepAlivePeriod: 15s

bandwidth:
  up: 500 mbps
  down: 500 mbps

log:
  level: warn
  file: $LOG_FILE
SERVEREOF

  cat > "$CLIENT_DIR/client.yaml" <<CLIENTEOF
server: $IP:$PORT
auth: $PASS

tls:
  sni: $SNI_DOMAIN
  insecure: $(if [[ "$USE_REAL_CERT" == "true" ]]; then echo "false"; else echo "true"; fi)

obfs:
  type: salamander
  salamander:
    password: $SALAMANDER_KEY

quic:
  initStreamReceiveWindow: 8388608
  maxStreamReceiveWindow: 8388608
  initConnReceiveWindow: 20971520
  maxConnReceiveWindow: 20971520

fastOpen: true

socks5:
  listen: 127.0.0.1:1080

http:
  listen: 127.0.0.1:1081

bandwidth:
  up: 100 mbps
  down: 100 mbps
CLIENTEOF

  LINK="hysteria2://$PASS@$IP:$PORT/?insecure=$(if [[ "$USE_REAL_CERT" == "true" ]]; then echo "0"; else echo "1"; fi)&sni=$SNI_DOMAIN&obfs=salamander&obfs-password=$SALAMANDER_KEY#HY2-Stealth"
  echo "$LINK" > "$CLIENT_DIR/link.txt"
  echo "$SALAMANDER_KEY" > "$CLIENT_DIR/salamander_key.txt"
  
  chmod 600 "$CLIENT_DIR"/*
  green "[*] é…ç½®ç”ŸæˆæˆåŠŸ"
}

create_service() {
  cat > /etc/systemd/system/hysteria2.service <<SERVICEEOF
[Unit]
Description=Hysteria2 Server
After=network.target nginx.service

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/hysteria server -c $CONFIG_DIR/config.yaml
Restart=always
RestartSec=5
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
SERVICEEOF

  systemctl daemon-reload
  systemctl enable hysteria2
  systemctl start hysteria2 || { red "[!] å¯åŠ¨å¤±è´¥"; journalctl -u hysteria2 -n 20; exit 1; }
  sleep 2
  systemctl is-active --quiet hysteria2 && green "[*] æœåŠ¡è¿è¡Œæ­£å¸¸" || red "[!] æœåŠ¡å¼‚å¸¸"
}

configure_firewall() {
  yellow "[*] é…ç½®é˜²ç«å¢™..."
  if command -v ufw &> /dev/null; then
    ufw --force reset
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow 22/tcp
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw allow $PORT/udp
    ufw --force enable
  fi
  
  iptables -I INPUT -p udp --dport $PORT -j ACCEPT
  iptables -I INPUT -p tcp --dport 80 -j ACCEPT
  iptables -I INPUT -p tcp --dport 443 -j ACCEPT
  iptables-save > /etc/iptables/rules.v4 2>/dev/null || true
  green "[*] é˜²ç«å¢™é…ç½®å®Œæˆ"
}

optimize_system() {
  yellow "[*] ä¼˜åŒ–ç³»ç»Ÿ..."
  cat >> /etc/sysctl.conf <<SYSCTLEOF

net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq
net.ipv4.tcp_fastopen = 3
fs.file-max = 1048576
SYSCTLEOF
  sysctl -p >/dev/null 2>&1
  green "[*] ç³»ç»Ÿä¼˜åŒ–å®Œæˆ"
}

generate_usage_info() {
  cat > "$CLIENT_DIR/usage.txt" <<USAGEEOF
===============================================
  Hysteria2 ç»ˆæéšè”½ç‰ˆ é…ç½®ä¿¡æ¯
===============================================

ã€æœåŠ¡å™¨ã€‘
IP: $IP
ç«¯å£: $PORT
å¯†ç : $PASS
SNI: $SNI_DOMAIN
Salamander: $SALAMANDER_KEY

ã€æ–‡ä»¶ã€‘
æœåŠ¡ç«¯: $CONFIG_DIR/config.yaml
å®¢æˆ·ç«¯: $CLIENT_DIR/client.yaml
å¯†é’¥: $CLIENT_DIR/salamander_key.txt

ã€è¿æ¥ã€‘
$(cat "$CLIENT_DIR/link.txt")

ã€å®¢æˆ·ç«¯ä½¿ç”¨ã€‘
hysteria -c client.yaml

ã€æœåŠ¡ç®¡ç†ã€‘
systemctl status/restart hysteria2
journalctl -u hysteria2 -f

ã€é‡è¦ã€‘
âš ï¸ å®¢æˆ·ç«¯å¿…é¡»é…ç½®Salamanderæ··æ·†
âš ï¸ å¯†é’¥å¿…é¡»å®Œå…¨ä¸€è‡´
âš ï¸ æ¨èå®˜æ–¹å®¢æˆ·ç«¯æˆ–Clash Meta

ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
===============================================
USAGEEOF
  chmod 600 "$CLIENT_DIR/usage.txt"
}

show_final_info() {
  clear
  green "=========================================="
  green "  Hysteria2 ç»ˆæéšè”½ç‰ˆå®‰è£…å®Œæˆ"
  green "  Salamander + çœŸå®ç½‘ç«™ä¼ªè£…"
  green "=========================================="
  echo ""
  yellow "ã€æœåŠ¡å™¨ä¿¡æ¯ã€‘"
  echo "  IP: $IP"
  echo "  ç«¯å£: $PORT"
  echo "  å¯†ç : $PASS"
  echo "  SNI: $SNI_DOMAIN"
  echo "  Salamander: $SALAMANDER_KEY"
  echo ""
  yellow "ã€é…ç½®æ–‡ä»¶ã€‘"
  echo "  $CLIENT_DIR/client.yaml"
  echo "  $CLIENT_DIR/link.txt"
  echo ""
  yellow "ã€è¿æ¥é“¾æ¥ã€‘"
  cat "$CLIENT_DIR/link.txt"
  echo ""
  if command -v qrencode &> /dev/null; then
    qrencode -t ANSIUTF8 "$(cat "$CLIENT_DIR/link.txt")" 2>/dev/null
    echo ""
  fi
  yellow "ã€ä¼ªè£…ç½‘ç«™ã€‘"
  echo "  https://$SNI_DOMAIN"
  echo ""
  green "è¯¦ç»†è¯´æ˜: cat $CLIENT_DIR/usage.txt"
  green "=========================================="
}

main() {
  clear
  green "=========================================="
  green "  Hysteria2 ç»ˆæéšè”½ç‰ˆå®‰è£…è„šæœ¬"
  green "=========================================="
  echo ""
  read -p "æŒ‰å›è½¦ç»§ç»­..." 
  
  install_deps
  get_ip
  generate_cert
  set_port
  install_hysteria
  generate_salamander_key
  deploy_fake_website
  configure_nginx
  write_config
  create_service
  configure_firewall
  optimize_system
  generate_usage_info
  show_final_info
  
  echo ""
  green "å®‰è£…å®Œæˆï¼"
}

main